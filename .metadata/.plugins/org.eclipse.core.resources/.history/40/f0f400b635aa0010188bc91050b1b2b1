import java.util.Properties;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.kedu.test.emails.emailbox.Email_boxService;
import com.kedu.test.emails.emailsender.Email_senderDAO;
import com.kedu.test.members.MemberService;

import jakarta.mail.Authenticator;
import jakarta.mail.Message;
import jakarta.mail.MessagingException;
import jakarta.mail.PasswordAuthentication;
import jakarta.mail.Session;
import jakarta.mail.Transport;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeMessage;

@Service
public class EmailService {

    // 각 기능별 DAO와 다른 Service들을 주입받습니다.
    private final EmailDAO emailDAO;
    private final Email_senderDAO email_senderDAO;
    private final MemberService memberService;
    private final Email_boxService email_boxService;

    public EmailService(EmailDAO emailDAO, Email_senderDAO email_senderDAO, MemberService memberService, Email_boxService email_boxService) {
        this.emailDAO = emailDAO;
        this.email_senderDAO = email_senderDAO;
        this.memberService = memberService;
        this.email_boxService = email_boxService;
    }

    // --- DAO 래퍼 메소드 (팀장님 요청 스타일) ---

    public void saveEmail(EmailDTO emailDto) {
        emailDAO.saveEmail(emailDto);
    }

    public void saveSender(Email_senderDTO emailSenderDto) {
        email_senderDAO.saveSender(emailSenderDto);
    }


    // --- 실제 비즈니스 로직 (위의 래퍼 메소드와 다른 서비스를 조합하여 사용) ---

    @Transactional
    public void sendTestMail() throws MessagingException {
        // --- 1. 테스트 데이터 정의 ---
        String senderEmail = "user01@test.com";
        String recipientEmail = "user01@test.com";

        // --- 2. 다른 서비스를 호출하여 필요한 정보 조회 ---
        int sentBoxSeq = email_boxService.findEmailboxSeqByEmailAndType(senderEmail, "보낸편지함");
        MemberDTO sender = memberService.findByEmail(senderEmail);
        final String password = sender.getPw();

        // --- 3. 우리 DB에 보낸 메일 기록 (래퍼 메소드 사용) ---
        EmailDTO emailDto = new EmailDTO();
        emailDto.setEmailbox_seq(sentBoxSeq);
        emailDto.setTitle("스프링 부트에서 보낸 테스트 메일");
        emailDto.setEmail_from(senderEmail);
        emailDto.setContent("이 메일이 성공적으로 보내졌다면, 발송 기능 구현이 완료된 것입니다.");
        this.saveEmail(emailDto); // saveEmail 래퍼 메소드 호출

        Email_senderDTO senderDto = new Email_senderDto();
        senderDto.setEmail_seq(emailDto.getEmail_seq());
        senderDto.setSender_email(recipientEmail);
        this.saveSender(senderDto); // saveSender 래퍼 메소드 호출

        // --- 4. James 메일 서버에 실제 발송 요청 ---
        Properties props = new Properties();
        props.put("mail.smtp.host", "localhost");
        props.put("mail.smtp.port", "587");
        props.put("mail.smtp.auth", "true");

        Session session = Session.getInstance(props, new Authenticator() {
            @Override
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(senderEmail, password);
            }
        });

        Message message = new MimeMessage(session);
        message.setFrom(new InternetAddress(senderEmail));
        message.setRecipients(Message.RecipientType.TO, InternetAddress.parse(recipientEmail));
        message.setSubject(emailDto.getTitle());
        message.setText(emailDto.getContent());

        Transport.send(message);
    }
}